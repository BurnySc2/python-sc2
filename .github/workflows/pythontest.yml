name: Python pipenv run pytest

# Help: https://help.github.com/en/actions/automating-your-workflow-with-github-actions/workflow-syntax-for-github-actions

on: [push, pull_request]

jobs:
  run_pytest_tests:
    name: Run pytest on pickle files
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.7, 3.8]

    steps:
    - uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip pipenv
        pipenv install --dev --python ${{ matrix.python-version }}

    - name: Run pipenv pytest tests on pickle files
      run: |
        pipenv run pytest test/


  run_autotest_bot:
    name: Run various tester bots on linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
    # Copy data from repository
    - uses: actions/checkout@v1

    - name: Print directories and files
      run: |
        # Print directory
        sudo apt-get install tree
        tree

    - name: Load and build docker image
      run: |
        # Build docker image from Dockerfile
        docker build -t test_image -f test/Dockerfile_3.7 .

    - name: Run autotest_bot.py
      run: |
        docker run -it -d --name app1 test_image
        docker exec -i app1 bash -c "python test/travis_test_script.py test/autotest_bot.py"
        docker rm -f app1

    - name: Run upgradestest_bot.py
      run: |
        docker run -it -d --name app2 test_image
        docker exec -i app2 bash -c "python test/travis_test_script.py test/upgradestest_bot.py"
        docker rm -f app2

    - name: Run damagetest_bot.py
      run: |
        docker run -it -d --name app3 test_image
        docker exec -i app3 bash -c "python test/travis_test_script.py test/damagetest_bot.py"
        docker rm -f app3